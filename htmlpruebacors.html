<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Demo API Tareas (Nivel 4)</title>
    <style>label{display:block;margin-top:8px}button{margin-top:6px}</style>
  </head>
  <body>
    <h2>Demo: registro / login / tareas (JWT)</h2>

    <section id="registro">
      <h3>Registro</h3>
      <label>Usuario <input id="reg_usuario"></label>
      <label>Email <input id="reg_email"></label>
      <label>Password <input id="reg_password" type="password"></label>
      <button id="reg_btn">Registrar</button>
      <pre id="reg_out"></pre>
    </section>

    <section id="login">
      <h3>Login</h3>
      <label>Usuario <input id="login_usuario"></label>
      <label>Password <input id="login_password" type="password"></label>
      <button id="login_btn">Login</button>
      <pre id="login_out"></pre>
    </section>

    <section id="tareas">
      <h3>Tareas (autenticado)</h3>
      <label>TÃ­tulo <input id="t_titulo"></label>
      <label>Hecha <input id="t_hecha" type="checkbox"></label>
      <button id="t_crear">Crear tarea</button>
      <button id="t_listar">Listar mis tareas</button>
      <pre id="t_out"></pre>
    </section>

    <script>
      const API_BASE = "http://127.0.0.1:5000";
      let token = null;

      async function post(path, body){
        const headers = {
          'Content-Type': 'application/json'
        };
        
        if (token && !path.includes('/auth/')) {
          headers['Authorization'] = `Bearer ${token}`;
          console.log('Enviando token:', token); // Debug
        }
        
        const res = await fetch(`${API_BASE}${path}`, {
          method: 'POST',
          headers: headers,
          body: JSON.stringify(body)
        });
        return res.json();
      }

      async function get(path){
        const headers = {};
        if (token) {
          headers['Authorization'] = `Bearer ${token}`;
          console.log('Enviando token en GET:', token); // Debug
        }
        const res = await fetch(`${API_BASE}${path}`, { headers });
        return res.json();
      }

      document.getElementById('reg_btn').onclick = async () => {
        const u = document.getElementById('reg_usuario').value;
        const e = document.getElementById('reg_email').value;
        const p = document.getElementById('reg_password').value;
        const r = await post('/api/v1/auth/register', { usuario: u, email: e, password: p });
        document.getElementById('reg_out').textContent = JSON.stringify(r, null, 2);
      };

      document.getElementById('login_btn').onclick = async () => {
        const u = document.getElementById('login_usuario').value;
        const p = document.getElementById('login_password').value;
        const r = await post('/api/v1/auth/login', { usuario: u, password: p });
        document.getElementById('login_out').textContent = JSON.stringify(r, null, 2);
        if(r.token){ 
          token = r.token;
          console.log('Token guardado:', token); // Debug
        }
      };

      document.getElementById('t_crear').onclick = async () => {
        const titulo = document.getElementById('t_titulo').value;
        const hecha = document.getElementById('t_hecha').checked;
        const r = await post('/api/v1/tareas', { titulo, hecha });
        document.getElementById('t_out').textContent = JSON.stringify(r, null, 2);
      };

      document.getElementById('t_listar').onclick = async () => {
        const r = await get('/api/v1/tareas');
        document.getElementById('t_out').textContent = JSON.stringify(r, null, 2);
      };
    </script>
  </body>
</html>
